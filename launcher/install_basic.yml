---
- apt:
    name:
      - curl
      - gnupg

- apt_key:
    url: https://bazel.build/bazel-release.pub.gpg
    state: present

- apt_repository:
    repo: deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8

    state: present
    filename: bazel.list

- apt: update_cache=yes

- apt:
    name:
      - bazel-3.1.0
    state: present

- file:
    src: /usr/bin/bazel-3.1.0
    dest:  /usr/bin/bazel
    state: link

- name: Install launcher requirements
  apt:
    name:
      - arpwatch
      - bazel-3.1.0
      - build-essential
      - colordiff
      - curl
      - cython                  # nsx-sdk builds
      - git
      - git-review
      - htop
      - lib32ncurses5-dev
      - lib32z1
      - mosh
      - nfs-common
      - python3
      - python3-pip
      - python-yaml
      - screen
      - tmux
      - traceroute
      - unzip
      - vim
      - yamllint
      - wireshark
    state: present

- file:
    src: /usr/bin/python3
    dest:  /usr/bin/python
    state: link

- name: Install PIP pre-requirements
  pip: name=pip state=latest

- name: Install PIP based requirements
  pip:
    state: latest
    name:
      - ipaddr
      - jinja2
      - mako
      - netaddr
      - pycodestyle
      - pylint
      - pyopenssl
      - pyyaml
      - scapy
      - termcolor

- pam_limits:
    domain: "*"
    limit_type: "{{item.limit_type}}"
    limit_item: "{{item.limit_item}}"
    value: "{{item.value}}"
  with_items:
    - {limit_type: '-', limit_item: 'nofile', value: 65536}
    - {limit_type: '-', limit_item: 'nproc', value: 65536}
    - {limit_type: 'soft', limit_item: 'memlock', value: unlimited}
    - {limit_type: 'hard', limit_item: 'memlock', value: unlimited}

- git_config:
    name: core.editor
    scope: global
    value: vim

# scope=system is the default
- git_config:
    name: alias.diffc
    value: diff --cached
    scope: global

- git_config:
    name: color.ui
    value: auto
    scope: global

- file:
   path: /build/apps
   state: directory

- file:
   path: /build/toolchain
   state: directory

- mount:
    path: /build/apps
    src: build-apps.eng.vmware.com:/apps
    fstype: nfs
    opts: rw
    state: mounted
- mount:
    path: /build/toolchain
    src: build-toolchain.eng.vmware.com:/toolchain
    fstype: nfs
    opts: rw
    state: mounted
